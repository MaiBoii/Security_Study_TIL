# ë³‘ë ¬(ë³‘í–‰)í”„ë¡œê·¸ë˜ë° í•™ìŠµ ì¤‘ìš”ì„±

ê²°ë¡ ë¶€í„° ë§í•˜ìë©´ í”„ë¡œê·¸ë˜ë° ì‘ì—…ì€ ìš´ì˜ì²´ì œì— ëŒ€í•œ ì§€ì‹ê³¼ ì‹¤í–‰íë¦„ì— ëŒ€í•œ ì´í•´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§„í–‰ë˜ì–´ì•¼ ì–‘ì§ˆì˜ ê²°ê³¼ë¬¼ì´ ë‚˜ì˜¤ê¸° ë•Œë¬¸ì„.

íŠ¹íˆ ë°±ì—”ë“œ ìª½ì—ì„œ ìŠ¤ë ˆë“œ, ìŠ¤ì¼€ì¤„ëŸ¬ ë¶€í•˜ê°€ í° ì‘ì—…ì„ ë‹¤ë£° ë•Œ (ex.ì¸í„°ë„· ë±…í‚¹, ì¦ì‹œ í˜„í™©)ì—ëŠ” í•´ë‹¹ ì§€ì‹ì´ ë”ë”ìš± ì ˆì‹¤í•´ì§. 

## í”„ë¡œì„¸ìŠ¤ vs ìŠ¤ë ˆë“œ ì°¨ì´

### í”„ë¡œì„¸ìŠ¤ 
- ìš´ì˜ì²´ì œì—ì„œ í• ë‹¹ë°›ëŠ” ìµœì†Œí•œì˜ ìì› ë‹¨ìœ„ë¥¼ ëœ»í•¨. 
- CPU ë™ì‘ ì‹œê°„, ì£¼ì†Œ ê³µê°„ì´ ì„œë¡œ ë…ë¦½ì ì„.
- Code,Data,Stack,Heap ê° ë©”ëª¨ë¦¬ ì˜ì—­ë“¤ì´ ì„œë¡œ ë…ë¦½ì ì„.
- ìµœì†Œ 1ê°œì˜ ë©”ì¸ ìŠ¤ë ˆë“œë¥¼ ë³´ìœ í•¨. 
- ë©”ëª¨ë¦¬ê°€ ì„œë¡œ ë…ë¦½ì ì´ì§€ë§Œ, íŒŒì´í”„, íŒŒì¼, ì†Œì¼“ ë“±ì˜ ê¸°ìˆ ë“¤ë¡œ í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹  ê°€ëŠ¥ (ê·¸ëŸ°ë° ë¹„ìš©ì´ í¼) ì „ë¬¸ìš©ì–´ë¡œ Context Switchingì´ë¼ê³  í•¨

### ìŠ¤ë ˆë“œ 
- í”„ë¡œì„¸ìŠ¤ ë‚´ì˜ ì‹¤í–‰ íë¦„ ë‹¨ìœ„ì„. 
- ê·¸ëŸ¬ë‹ˆ ë‹¹ì—°íˆ í”„ë¡œì„¸ìŠ¤ ë‚´ì˜ ìì›ì„ ì‚¬ìš©í•¨.
- Stackë§Œ ë³„ë„ë¡œ ì‚¬ìš©í•˜ê³ , ë‚˜ë¨¸ì§€ ë©”ëª¨ë¦¬ ì˜ì—­(Code, Data, Heap)ì€ ìê¸°ë“¤ë¼ë¦¬ ê³µìœ í•¨. (ë³€ìˆ˜ ê³µìœ )
- í•œ ìŠ¤ë ˆë“œì˜ ê²°ê³¼ê°€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ê²Œ ì˜í–¥ì„ ë¯¸ì¹¨.
    - ê·¸ë˜ì„œ ë™ê¸°í™” ë¬¸ì œëŠ” ì •ë§ë¡œ ì£¼ì˜í•´ì•¼í•¨. (ë””ë²„ê¹…ì´ í˜ë“¦.)

### ë©€í‹° ìŠ¤ë ˆë“œ 
- í•œ ê°œì˜ ë‹¨ì¼ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¡œ êµ¬ì„± í›„ ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒ
- ê·¸ëŸ¬ë‹ˆ ì‹œìŠ¤í…œ ìì›ì´ ëœ ì†Œëª¨ë¨ (íš¨ìœ¨ì„±, ì²˜ë¦¬ëŸ‰ ì¦ê°€)
    - í•˜ì§€ë§Œ ì–´ë–»ê²Œ ì§œëŠëƒì— ë”°ë¼ í”„ë¡œì„¸ìŠ¤ ì—¬ëŸ¬ ê°œ ëŒë¦¬ëŠ” ê²ƒë³´ë‹¤ ë” ëª»í•  ìˆ˜ë„ ìˆìŒ
- í†µì‹ ë¶€ë‹´ ê°ì†Œ, ë””ë²„ê¹…ì€ ì–´ë ¤ì›Œì§, ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ì—ëŠ” íš¨ê³¼ê°€ ë¯¸ì•½í•  ìˆ˜ ìˆìŒ. (ìš”ìƒˆëŠ” CPU ì„±ëŠ¥ì´ ì¢‹ì•„ì„œ), ìì› ê³µìœ  ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆìŒ(êµì°© ìƒíƒœ), í”„ë¡œì„¸ìŠ¤ ì˜í–¥ ë¼ì¹¨

### ë©€í‹° í”„ë¡œì„¸ìŠ¤ 
- í•œ ê°œì˜ ë‹¨ì¼ ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ë¡œ êµ¬ì„± í›„ ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒ
- í•œ ê°œì˜ í”„ë¡œì„¸ìŠ¤ì—ì„œ ë¬¸ì œ ë°œìƒ ì‹œ í™•ì‚°ì€ ì—†ìŒ. í•œ ë†ˆë§Œ kill -9 í•˜ë©´ ë˜ë‹ˆê¹ 
- ìºì‹œ ì²´ì¸ì§€ë¥¼ í™œìš©í•˜ë©°, Cost ë¹„ìš©ì´ ë§¤ìš° ë†’ìŒ (ì˜¤ë²„í—¤ë“œ ìƒìŠ¹ ê°€ëŠ¥ì„±), ë³µì¡í•œ í†µì‹  ë°©ì‹ ì‚¬ìš© 



## GIL (Global Interpreter Lock)
- ìš°ë¦¬ê°€ ê°€ì¥ ìì£¼ ì“°ëŠ” ê¸°ë³¸ì ì¸ íŒŒì´ì¬ ì¸í„°í”„ë¦¬í„°ë¥¼ CPythonì´ë¼ê³  í•¨.
- ì´ CPython ì¸í„°í”„ë¦¬í„°ê°€ ìš°ë¦¬ê°€ ì“´ íŒŒì´ì¬ ì½”ë“œë¥¼ byte codeë¡œ ë°”ê¿”ì„œ ì‹¤í–‰ ì‹œí‚´.
- ì´ ê³¼ì •ì—ì„œ ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•  ê²½ìš° 'ë‹¨ í•˜ë‚˜'ì˜ ìŠ¤ë ˆë“œë§Œ ê°ì²´ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ì œí•œí•´ë†¨ìŒ. ì´ê±¸ GILì´ë¼ê³  í•¨.

![alt text](GIL.png)

### Q. ì´ë”´ ê±° ì™œ ë§Œë“¦?? ê·¸ëŸ¼ ë³‘ë ¬ì²˜ë¦¬ëŠ” ì–´ë–»ê²Œ í•¨?
1. CPythonì€ ê°ì²´ ì°¸ì¡°ë¥¼ ì‚¬ìš©í•´ì„œ ë©”ëª¨ë¦¬ë¥¼ ê´€ë¦¬í•˜ëŠ”ë° ìŠ¤ë ˆë“œë¥¼ ì—¬ëŸ¬ ê°œ ìš´ìš©í•˜ë©´ ì˜¤ë¥˜ë‚˜ ì¶©ëŒì´ ì¼ì–´ë‚˜ê¸° ì‰¬ìš´ êµ¬ì¡°ë¼ì„œ ê·¸ëŸ¼. (Thread-Safe ë¬¸ì œ)
2. ë‹¨ì¼ ìŠ¤ë ˆë“œ ì¨ë„ ì¶©ë¶„íˆ ë¹ ë¦„ 
3. ë©€í‹° í”„ë¡œì„¸ìŠ¤ ì¨ë„ GIL ë°”ê¹¥ ì˜ì—­ì—ì„œ íš¨ìœ¨ì ì¸ ì½”ë”© ê°€ëŠ¥í•¨.
4. ë³‘ë ¬ ì²˜ë¦¬ëŠ” Multiprocessing, asyncio ë“± ì„ íƒì§€ ë‹¤ì–‘í•¨.
5. thread ë™ì‹œì„± êµ¬í˜„ì„ ìœ„í•´ì„œ Jython, IronPython ë“± ë‹¤ë¥¸ ì¸í„°í”„ë¦¬í„°ë“¤ë„ ì‚¬ìš© ê°€ëŠ¥í•¨. 

### Q. ì–´? ê·¸ëŸ¼ ì €ë²ˆì— ë‚´ê°€ ì¼ë˜ threading ëª¨ë“ˆì€ ë­ì˜€ì§€?
1. threadingì€ OS ìŠ¤ë ˆë“œë¥¼ ìƒì„±í•¨.
- ë‚´ë¶€ì ìœ¼ë¡œëŠ” C ì–¸ì–´ì˜ pthread (POSIX thread)ë‚˜ Windows ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•´ì„œ ì‹¤ì œ OS ìˆ˜ì¤€ì˜ ìŠ¤ë ˆë“œë¥¼ ë§Œë“¦.
- ê·¸ëŸ¬ë‹ˆê¹Œ ë©€í‹°ìŠ¤ë ˆë“œì¸ê±°ëŠ” ë§ë‹¤! í•˜ì§€ë§Œ...

2. CPythonì˜ GILì´ ëª¨ë“  ìŠ¤ë ˆë“œì˜ ì‹¤í–‰ì„ ìˆœì°¨í™”í•¨.
- í•œ ìˆœê°„ì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•¨.

3. ìŠ¤ë ˆë“œëŠ” *ì§§ì€ ì‹œê°„ë§ˆë‹¤ GILì„ ì–‘ë³´(switch)* í•˜ë©´ì„œ ëŒì•„ê°€ê²Œ ë¨. (ë³´í†µ 5ms ë‹¨ìœ„).
- ê·¸ëŸ¬ë‹ˆ ì—„ë°€íˆ ë§í•˜ìë©´ ì´ê²Œ ë³‘ë ¬ ì‹¤í–‰ê°™ì•„ ë³´ì—¬ë„ ã„¹ã…‡ ì§„ì§œ ë³‘ë ¬ì€ ì•„ë‹Œê±°ì„.

---

## ì‹¤ìŠµ 
```python
import logging
import threading
import time

def thread_func(name):
    logging.info("Sub-Thread: %s: Starting", name)
    time.sleep(3)
    logging.info("Sub-Thread: %s: Finishing", name)


if __name__ == "__main__":
    # Logging í¬ë§· ì„¤ì •í•˜ê¸° 
    format = "%(asctime)s: %(message)s"
    logging.basicConfig(format=format, level=logging.INFO, datefmt="%H:%M:%S")
    logging.info("Main-Thread: before creating Thread")

    # í•¨ìˆ˜ ì¸ì í™•ì¸
    x = threading.Thread(target=thread_func, args=("First", ))

    logging.info("Main-Thread: before running Thread")

    x.start()

    logging.info("Main-Thread: Waiting For the Thread To Finish.")

    logging.info("Main-Thread: Now All Finished!")

```

```
21:54:28: Main-Thread: before creating Thread
21:54:28: Main-Thread: before running Thread
21:54:28: Sub-Thread: First: Starting
21:54:28: Main-Thread: Waiting For the Thread To Finish.
21:54:28: Main-Thread: Now All Finished!
21:54:31: Sub-Thread: First: Finishing
```

ìš”ì ì€ ë¶€ëª¨ ìŠ¤ë ˆë“œê°€ ë¨¼ì € ëë‚˜ë„ ìì‹ ìŠ¤ë ˆë“œëŠ” ëê¹Œì§€ ë§¡ì€ ì¼ì„ ë‹¤ í•˜ê³  ì¢…ë£Œëœë‹¤ëŠ” ê±°ì„.

ê·¸ëŸ°ë° thread join()ì„ ì‚¬ìš©í•˜ë©´

```python
import logging
import threading
import time

def thread_func(name):
    logging.info("Sub-Thread: %s: Starting", name)
    time.sleep(3)
    logging.info("Sub-Thread: %s: Finishing", name)


if __name__ == "__main__":
    # Logging í¬ë§· ì„¤ì •í•˜ê¸° 
    format = "%(asctime)s: %(message)s"
    logging.basicConfig(format=format, level=logging.INFO, datefmt="%H:%M:%S")
    logging.info("Main-Thread: before creating Thread")

    # í•¨ìˆ˜ ì¸ì í™•ì¸
    x = threading.Thread(target=thread_func, args=("First", ))

    logging.info("Main-Thread: before running Thread")

    x.start()
    
    # join() ëª…ë ¹ì–´ ì¶”ê°€
    x.join()

    logging.info("Main-Thread: Waiting For the Thread To Finish.")

    logging.info("Main-Thread: Now All Finished!")

```

```bash
21:59:57: Main-Thread: before creating Thread
21:59:57: Main-Thread: before running Thread
21:59:57: Sub-Thread: First: Starting
22:00:00: Sub-Thread: First: Finishing
22:00:00: Main-Thread: Waiting For the Thread To Finish.
22:00:00: Main-Thread: Now All Finished!
```

ìì‹ ìŠ¤ë ˆë“œê°€ ëë‚  ë•Œê¹Œì§€ ë¶€ëª¨ ìŠ¤ë ˆë“œê°€ í•´ë‹¹ ì§€ì ì—ì„œ ëŒ€ê¸°í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŒ.

---
## Daemon Tread (ë°ëª¬ ìŠ¤ë ˆë“œ)
- ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
- ìì‹ ì„ ìƒì„±í•œ ë¶€ëª¨ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ë©´ ì¦‰ì‹œ ê°•ì œì¢…ë£Œë¨ 
- ì£¼ë¡œ ë°±ê·¸ë¼ìš´ë“œ ë¬´í•œëŒ€ê¸° ì´ë²¤íŠ¸ ë°œìƒ ì‹¤í–‰í•˜ëŠ” ë¶€ë¶„ì„ ë‹´ë‹¹í•¨.
- EX. ìë°”ì˜ ê°€ë¹„ì§€ì»¬ë ˆì…˜, ìë™ ì €ì¥ ì‹œìŠ¤í…œ ë“± 
- ë¬¼ë¡  ì¼ë°˜ ìŠ¤ë ˆë“œëŠ” ë¶€ëª¨ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ì–´ë„ ì¢…ë£Œë˜ì§€ ì•ŠìŒ.

## ThreadPoolExecutor (ê·¸ë£¹ ìŠ¤ë ˆë“œ)
- Python 3.2 ë²„ì „ ì´ìƒë¶€í„° ì§€ì›
- concurrent.futures
- withë¬¸ ì‚¬ìš©ìœ¼ë¡œ ìƒì„±-ì†Œë©¸ ë¼ì´í”„ì‚¬ì´í´ ìƒì„±ì„ ìš©ì´í•˜ê²Œ í•´ì¤Œ
- ëŒ€ì‹ ì— ë””ë²„ê¹…í•˜ê¸°ê°€ ë‚œí•´í•œê²Œ ë‹¨ì ì„
- ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…ì´ Queueì— ë‹´ê¸°ê³ , ì™„ë£Œ ìƒíƒœ ì¡°ì‚¬ í›„ ê²°ê³¼ ë˜ëŠ” ì˜ˆì™¸ ë°œìƒì‹œí‚¤ëŠ” ì›ë¦¬


---

## ì„¸ë§ˆí¬ì–´ (Semaphore)
-> í”„ë¡œì„¸ìŠ¤ ê°„ ê³µìœ ëœ ìì›ì— ì ‘ê·¼ ì‹œ ë°œìƒí•  ë¬¸ì œ ê°€ëŠ¥ì„±ë¥¼ ë§‰ê¸°ìœ„í•´ í•œ ê°œì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ì ‘ê·¼ ì²˜ë¦¬ë¥¼ ê³ ì•ˆí•¨ 

## ë®¤í…ìŠ¤ (Mutex)
-> ê³µìœ ëœ ìƒíƒœì˜ ë°ì´í„°ì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë§‰ëŠ” ê²ƒ 

## Lock 
-> ìƒí˜¸ ë°°ì œë¥¼ ìœ„í•œ ì ê¸ˆ ì²˜ë¦¬ (ë°ì´í„° ê²½ìŸ)

## DeadLock
-> í”„ë¡œì„¸ìŠ¤ê°€ ìì›ì„ íšë“í•˜ì§€ ëª»í•´ì„œ ë‹¤ìŒ ì²˜ë¦¬ë¥¼ ëª»í•˜ëŠ” ë¬´í•œ ëŒ€ê¸° ìƒí™©(êµì°© ìƒíƒœ)

## Thread Synchronization (ìŠ¤ë ˆë“œ ë™ê¸°í™”)
-> êµì°© ìƒíƒœë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œ êµí†µ ì •ë¦¬ë¥¼ í•˜ëŠ” ì‘ì—… (ë™ê¸°í™” ë©”ì†Œë“œ, ë™ê¸°í™” ë¸”ëŸ­)

## ì„¸ë§ˆí¬ì–´ vs ë®¤í…ìŠ¤?
- ë‘˜ ë‹¤ ë³‘ë ¬ í”„ë¡œê·¸ë˜ë°ì—ì„œ ìƒí˜¸ë°°ì œë¥¼ ìœ„í•´ ì‚¬ìš©ëœë‹¤ëŠ” ê³µí†µì ì´ ìˆìŒ.
- ë®¤í…ìŠ¤ ê°œì²´ëŠ” ë‹¨ì¼ ìŠ¤ë ˆë“œê°€ ë¦¬ì†ŒìŠ¤ í˜¹ì€ ì¤‘ìš” ì„¹ì…˜ì„ ì†Œë¹„ í—ˆìš©
- ì„¸ë§ˆí¬ì–´ëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì œí•œëœ ìˆ˜ì˜ ë™ì‹œ ì—‘ì„¸ìŠ¤ë¥¼ í—ˆìš© 


| êµ¬ë¶„        | **Mutex**                                 | **Semaphore**                |
| --------- | ----------------------------------------- | ---------------------------- |
| ê°œë…        | **ìƒí˜¸ ë°°ì œ**(Mutual Exclusion)               | **ì‹ í˜¸**(Signaling) ê¸°ë°˜ ìì› ìˆ˜ ì œì–´ |
| ê°’         | 0 ë˜ëŠ” 1 (ì´ì§„ ë½)                             | 0 ì´ìƒì¸ ì •ìˆ˜                     |
| ìì› ìˆ˜      | ì˜¤ì§ 1ê°œ ìì› ë³´í˜¸                               | ì—¬ëŸ¬ ê°œì˜ ìì›ì„ ë™ì‹œì— ë³´í˜¸ ê°€ëŠ¥          |
| ì†Œìœ ê¶Œ       | ìŠ¤ë ˆë“œê°€ ì†Œìœ  (unlockì€ ownerë§Œ ê°€ëŠ¥)               | ì†Œìœ  ê°œë… ì—†ìŒ (ëˆ„êµ¬ë‚˜ release ê°€ëŠ¥)    |
| ì‚¬ìš© ëª©ì      | í•˜ë‚˜ì˜ ê³µìœ  ìì›ì— **í•˜ë‚˜ì”©** ì ‘ê·¼                     | ë™ì‹œì— ì ‘ê·¼ ê°€ëŠ¥í•œ **ìì› ìˆ˜ë¥¼ ì œí•œ**      |
| ì˜ˆì‹œ ìƒí™©     | í”„ë¦°í„° 1ëŒ€                                    | DB ì—°ê²° í’€ 5ê°œ, ë„¤íŠ¸ì›Œí¬ í¬íŠ¸ 3ê°œ ë“±     |
| Python ëª¨ë“ˆ | `threading.Lock()` ë˜ëŠ” `threading.RLock()` | `threading.Semaphore(value)` |


---

* ğŸ”’ **Mutex** = ìë¬¼ì‡ , í•˜ë‚˜ë§Œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ë°©
* ğŸš¦ **Semaphore** = ì‹ í˜¸ë“±, ë™ì‹œì— nëª… ë“¤ì–´ê°ˆ ìˆ˜ ìˆìŒ (ex. í™”ì¥ì‹¤ ì¹¸ 3ê°œ)

---

| ìƒí™©                           | ì„ íƒ           |
| ---------------------------- | ------------ |
| ìì›ì— í•˜ë‚˜ì”©ë§Œ ì ‘ê·¼í•´ì•¼ í•¨              | Mutex (Lock) |
| ìì›ì´ ì—¬ëŸ¬ ê°œ ìˆê³ , ê·¸ ìˆ˜ë§Œí¼ ë™ì‹œì— ì ‘ê·¼ ê°€ëŠ¥ | Semaphore    |

ìƒí™©ì— ë§ê²Œ ë‹ˆ ì•Œì•„ì„œ ì“°ì…ˆ ã…‡ã…‡ 


## ë§Œì•½ì— ì´ëŸ° ì¥ì¹˜ë“¤ì´ ì—†ë‹¤ë©´??

```python
import logging
from concurrent.futures import ThreadPoolExecutor
import time

class FakeDataStore:
    # ê³µìœ  ë³€ìˆ˜ ì„¤ì • (ìŠ¤íƒ ì˜ì—­)
    def __init__(self):
        self.value = 0

    # ë³€ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸ ì‹œí‚¤ëŠ” í•¨ìˆ˜
    def update(self,n):
        logging.info('Thread %s: ì—…ë°ì´íŠ¸ ì‹œì‘', n)

        # Mutex (Lock) ë“± ë™ê¸°í™”ê°€ í•„ìš”í•œ ì§€ì 
        local_copy = self.value # local_copyì˜ ìŠ¤íƒ ì˜ì—­ì— 0ì„ ì €ì¥
        local_copy += 1
        time.sleep(0.1)
        self.value = local_copy # ì—…ë°ì´íŠ¸ ì ìš©

        logging.info('Thread %s: ì—…ë°ì´íŠ¸ ë§ˆì¹¨', n)

if __name__ == "__main__":
    # Logging format ì„¤ì •
    format = "%(asctime)s: %(message)s"
    logging.basicConfig(format=format, level=logging.INFO, datefmt="%H:%M:%S")

    # í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤í™”
    store = FakeDataStore()

    logging.info("Testing update. Starting value is %d.", store.value)

    # With Context ì‹œì‘
    with ThreadPoolExecutor(max_workers=2) as executor:
        for n in ['First', 'Second', 'Third']:
            executor.submit(store.update, n)

    logging.info("Testing update. Ending value is %d.", store.value)
```

í•´ë‹¹ ì½”ë“œëŠ” ë³´ë‹¤ì‹œí”¼ ì„¸ ê°œì˜ ìŠ¤ë ˆë“œë¡œ ì „ì—­ë³€ìˆ˜ì— ê°ê° 1ì”© ë”í•´ì„œ 3ì„ ë§Œë“¤ì–´ ì¤˜ì•¼í•˜ì§€ë§Œ.

```zsh
16:06:59: Testing update. Starting value is 0.
16:06:59: Thread First: ì—…ë°ì´íŠ¸ ì‹œì‘
16:06:59: Thread Second: ì—…ë°ì´íŠ¸ ì‹œì‘
16:07:00: Thread First: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
16:07:00: Thread Second: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
16:07:00: Thread Third: ì—…ë°ì´íŠ¸ ì‹œì‘
16:07:00: Thread Third: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
16:07:00: Testing update. Ending value is 2.
```

ì–´ì°Œëœ ì˜ë¬¸ì¸ì§€ 2ê°€ ë‚˜ì˜¤ê²Œ ëœë‹¤.


```scss
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ ì½”ë“œ ì˜ì—­    â”‚ â† í”„ë¡œê·¸ë¨ì˜ ëª…ë ¹ì–´(ê¸°ê³„ì–´)
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚ ë°ì´í„° ì˜ì—­   â”‚ â† ì „ì—­ë³€ìˆ˜, static ë³€ìˆ˜ 
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚ í™ ì˜ì—­      â”‚ â† ê°ì²´, ë¦¬ìŠ¤íŠ¸, í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ë“± (ë™ì  í• ë‹¹)
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚ ìŠ¤íƒ ì˜ì—­    â”‚ â† í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ìƒì„±ë˜ëŠ” ì§€ì—­ ë³€ìˆ˜, ë§¤ê°œë³€ìˆ˜
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```



í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•˜ê²Œ ë˜ë©´ ìƒê¸° ê·¸ë¦¼ì²˜ëŸ¼ ë©”ëª¨ë¦¬ ì˜ì—­ì´ ë‚˜ë‰˜ê²Œ ë¨. 

| ì˜ì—­                | ì„¤ëª…                                               | ì˜ˆì‹œ                        |
| ----------------- | ------------------------------------------------ | ------------------------- |
| **ì½”ë“œ ì˜ì—­ (Code)**  | í”„ë¡œê·¸ë¨ì˜ **ê¸°ê³„ì–´ ì½”ë“œ**ê°€ ì €ì¥ë¨                            | `def func():` ë“± í•¨ìˆ˜ ì •ì˜ ìì²´  |
| **ë°ì´í„° ì˜ì—­ (Data)** | **ì „ì—­ë³€ìˆ˜**, static ë³€ìˆ˜ ì €ì¥ë¨                          | `global counter = 0`      |
| **í™ ì˜ì—­ (Heap)**   | `class`, `list`, `dict`, `object` ë“± **ë™ì  ê°ì²´ ì €ì¥** | `self.value`, `MyClass()` |
| **ìŠ¤íƒ ì˜ì—­ (Stack)** | í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ë§Œë“¤ì–´ì§€ëŠ” **ì§€ì—­ ë³€ìˆ˜, ë§¤ê°œë³€ìˆ˜**                    | `local_copy` ê°™ì€ ë³€ìˆ˜        |



ê·¸ë¦¬ê³  ìœ„ì—ì„œë„ ë§í–ˆë‹¤ì‹œí”¼ ìŠ¤íƒì˜ì—­ì€ ëª¨ë“  ê° ìŠ¤ë ˆë“œë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ ìƒì„±ë¨.

| ë©”ëª¨ë¦¬ ì˜ì—­ | ë©€í‹°ìŠ¤ë ˆë“œ ê°„ ê³µìœ  | ì„¤ëª…                                   |
| ------ | ----------- | ------------------------------------ |
| ì½”ë“œ ì˜ì—­  | âœ… ê³µìœ ë¨       | í•¨ìˆ˜, í´ë˜ìŠ¤ ë“±ì€ ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë™ì¼í•œ ì½”ë“œë¥¼ ì‹¤í–‰        |
| ë°ì´í„° ì˜ì—­ | âœ… ê³µìœ ë¨       | ì „ì—­ ë³€ìˆ˜ëŠ” ëª¨ë‘ê°€ ì ‘ê·¼ ê°€ëŠ¥ â†’ **ê²½ìŸ ì¡°ê±´ ìœ„í—˜**      |
| í™ ì˜ì—­   | âœ… ê³µìœ ë¨       | `self.value` ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ â†’ **ë™ê¸°í™” í•„ìš”** |
| ìŠ¤íƒ ì˜ì—­  | âŒ ê° ìŠ¤ë ˆë“œë³„ ë…ë¦½ | í•¨ìˆ˜ ë‚´ ì§€ì—­ ë³€ìˆ˜ëŠ” **ê° ìŠ¤ë ˆë“œì— ë…ë¦½ì ìœ¼ë¡œ ìƒì„±ë¨**     |


1. max_workersê°€ 2ë¡œ ì„¤ì •í•˜ëŠ” ë°”ëŒì— ìŠ¤ë ˆë“œ Firstì™€ Secondê°€ ê°ìì˜ ì§€ì—­ë³€ìˆ˜ë¥¼ ë„£ìœ¼ë ¤ê³  ê²½ìŸì„ ë¶™ê²Œ ë˜ì—ˆê³ ,
2. ê²°êµ­ ì‘ì—… í•˜ë‚˜ê°€ ì†Œì‹¤ëœ ìƒíƒœì—ì„œ Thirdê°€ ì ìš©ë˜ì—ˆê³ ,
3. ê·¸ë˜ì„œ 1ì´ ëª¨ìë€ê±°ì„. 


(ì€í–‰ì´ë‚˜ ì¦ê¶ŒíšŒì‚¬ ê°™ì€ ê³³ì—ì„œ ì´ëŸ° ì‚¬ê³ ê°€ í„°ì§€ë©´ ì¹¼ë¶€ë¦¼ì´ ë‚œë‹¤ê³  ì™¸ì£¼ ì•Œë°”í•˜ë‹¤ ë§Œë‚œ ê°œë°œì ì•„ì €ì”¨ê°€ ê·¸ë¬ë˜ ê²ƒ ê°™ë‹¤.)


## ê²½ìŸ ìƒíƒœë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ì„ ?

### ë°©ë²• 1

```python

class FakeDataStore:
    # ê³µìœ  ë³€ìˆ˜ ì„¤ì • (ìŠ¤íƒ ì˜ì—­)
    def __init__(self):
        self.value = 0
        self._lock = threading.Lock()

    # ë³€ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸ ì‹œí‚¤ëŠ” í•¨ìˆ˜
    def update(self,n):
        logging.info('Thread %s: ì—…ë°ì´íŠ¸ ì‹œì‘', n)

        # Mutex (Lock) ë“± ë™ê¸°í™”ê°€ í•„ìš”í•œ ì§€ì 

        self._lock.acquire()
        logging.info("Thread %s ë½ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.", n)
    
        local_copy = self.value # local_copyì˜ ìŠ¤íƒ ì˜ì—­ì— 0ì„ ì €ì¥
        local_copy += 1
        time.sleep(0.1)
        self.value = local_copy

        logging.info('Thread %sì´ ë½ì„ í’€ë ¤ê³ í•©ë‹ˆë‹¤.', n)
        
        # Lock ë°˜í™˜
        self._lock.release()

        logging.info('Thread %s: ì—…ë°ì´íŠ¸ ë§ˆì¹¨', n)

```

```zsh
17:01:14: Testing update. Starting value is 0.
17:01:14: Thread First: ì—…ë°ì´íŠ¸ ì‹œì‘
17:01:14: Thread First ë½ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.
17:01:14: Thread Second: ì—…ë°ì´íŠ¸ ì‹œì‘
17:01:14: Thread Firstì´ ë½ì„ í’€ë ¤ê³ í•©ë‹ˆë‹¤.
17:01:14: Thread First: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
17:01:14: Thread Third: ì—…ë°ì´íŠ¸ ì‹œì‘
17:01:14: Thread Second ë½ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.
17:01:14: Thread Secondì´ ë½ì„ í’€ë ¤ê³ í•©ë‹ˆë‹¤.
17:01:14: Thread Second: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
17:01:14: Thread Third ë½ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.
17:01:14: Thread Thirdì´ ë½ì„ í’€ë ¤ê³ í•©ë‹ˆë‹¤.
17:01:14: Thread Third: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
17:01:14: Testing update. Ending value is 3.
```

ê° ìŠ¤ë ˆë“œë‹¹ í•˜ë‚˜ì”©ë§Œ ì—´ì‡ ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆê²Œ ë§Œë“¦ìœ¼ë¡œì¨ ì‘ì—… ì†ì‹¤ì„ ë°©ì§€í•¨.

### ë°©ë²• 2
withë¬¸ ì‚¬ìš©í•˜ê¸° 

```python

class FakeDataStore:
    # ê³µìœ  ë³€ìˆ˜ ì„¤ì • (ìŠ¤íƒ ì˜ì—­)
    def __init__(self):
        self.value = 0
        self._lock = threading.Lock()

    # ë³€ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸ ì‹œí‚¤ëŠ” í•¨ìˆ˜
    def update(self,n):
        logging.info('Thread %s: ì—…ë°ì´íŠ¸ ì‹œì‘', n)

        # Mutex (Lock) ë“± ë™ê¸°í™”ê°€ í•„ìš”í•œ ì§€ì 

        with self._lock:
            logging.info("Thread %s ë½ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.", n)
    
            local_copy = self.value # local_copyì˜ ìŠ¤íƒ ì˜ì—­ì— 0ì„ ì €ì¥
            local_copy += 1
            time.sleep(0.1)
            self.value = local_copy

            logging.info('Thread %sì´ ë½ì„ í’€ë ¤ê³ í•©ë‹ˆë‹¤.', n)

        logging.info('Thread %s: ì—…ë°ì´íŠ¸ ë§ˆì¹¨', n)
```

```zsh
17:05:02: Testing update. Starting value is 0.
17:05:02: Thread First: ì—…ë°ì´íŠ¸ ì‹œì‘
17:05:02: Thread First ë½ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.
17:05:02: Thread Second: ì—…ë°ì´íŠ¸ ì‹œì‘
17:05:02: Thread Firstì´ ë½ì„ í’€ë ¤ê³ í•©ë‹ˆë‹¤.
17:05:02: Thread First: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
17:05:02: Thread Third: ì—…ë°ì´íŠ¸ ì‹œì‘
17:05:02: Thread Second ë½ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.
17:05:02: Thread Secondì´ ë½ì„ í’€ë ¤ê³ í•©ë‹ˆë‹¤.
17:05:02: Thread Second: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
17:05:02: Thread Third ë½ì„ ê°€ì¡ŒìŠµë‹ˆë‹¤.
17:05:02: Thread Thirdì´ ë½ì„ í’€ë ¤ê³ í•©ë‹ˆë‹¤.
17:05:02: Thread Third: ì—…ë°ì´íŠ¸ ë§ˆì¹¨
17:05:02: Testing update. Ending value is 3.
```


---

# Prod and Cons of Queue

## Queueë€
í(queue)ëŠ” ì»´í“¨í„°ì˜ ê¸°ë³¸ì ì¸ ìë£Œ êµ¬ì¡°ì˜ í•œê°€ì§€ë¡œ, ë¨¼ì € ì§‘ì–´ ë„£ì€ ë°ì´í„°ê°€ ë¨¼ì € ë‚˜ì˜¤ëŠ” ì„ ì…ì„ ì¶œ í˜•ì‹ì„ ë”.

## ìƒì‚°ì-ì†Œë¹„ì íŒ¨í„´ 
- ë³‘ë ¬ í”„ë¡œê·¸ë˜ë° ë””ìì¸ íŒ¨í„´ ì¤‘ ì •ì„
- ì„œë²„ ì¸¡ í”„ë¡œê·¸ë˜ë°ì˜ í•µì‹¬ì´ì í—ˆë¦¬ ì—­í• 

## Python Event
- Flagì˜ ì´ˆê¹ƒê°’ì€ 0ìœ¼ë¡œ ì„¤ì •
- Set()ìœ¼ë¡œ í˜¸ì¶œí•˜ë©´ 1ë¡œ ì„¤ì •
- Clear()ë¡œ í˜¸ì¶œí•˜ë©´ 0ìœ¼ë¡œ ì„¤ì •
- Wait()ì´ë©´ (1-> ë¦¬í„´) or (0-> ëŒ€ê¸°)
- isSet()ì´ë©´ í˜„ í”Œë˜ê·¸ ìƒíƒœ ì¶œë ¥

```python
import concurrent.futures
import queue
import time
import random
import logging
import threading


# ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ë‚´ëŠ” ìª½ (I/Oë‚˜ ë„¤íŠ¸ì›Œí¬ ì‘ì—… ìŠ¤ë ˆë“œ)
def producer(queue, event):
    """ë„¤íŠ¸ì›Œí¬ ëŒ€ê¸° ìƒíƒœë¼ ê°€ì •(ì„œë²„)"""
    while not event.is_set():
        message = random.randint(1,11)
        logging.info('ìƒì‚°ìê°€ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤: %s',message)
        queue.put(message)
        
    logging.info('ìƒì‚°ìê°€ ì´ë²¤íŠ¸ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.')

# ì†Œë¹„ì (CPU ì‘ì—… ìŠ¤ë ˆë“œ)
def consumer(queue, event):
    """ì‘ë‹µ ë°›ê³  ì†Œë¹„í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì • or DB ì €ì¥"""
    while not event.is_set() or not  queue.empty():
        message = queue.get()
        logging.info('ì†Œë¹„ìê°€ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤: %s (size=%d)',message, queue.qsize())

    logging.info('ì†Œë¹„ìê°€ ì´ë²¤íŠ¸ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.')



if __name__ == "__main__":
    # Logging format ì„¤ì •
    format = "%(asctime)s: %(message)s"
    logging.basicConfig(format=format, level=logging.INFO,
                        datefmt="%H:%M:%S")

    # ì‚¬ì´ì¦ˆ ì„¤ì •ì´ ì¤‘ìš”í•¨
    pipeline = queue.Queue(maxsize=10)

    #ì´ë²¤íŠ¸ í”Œë˜ê·¸ ë³€ìˆ˜ ì„¤ì •í•˜ê¸°
    event = threading.Event()

    #With Context
    with concurrent.futures.ThreadPoolExecutor(max_workers=2) as excuter:
        # ì‹¤í–‰í•  í•¨ìˆ˜ producerì— Queueì™€ event 2ê°œì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ ì§‘ì–´ë„£ìŒ
        excuter.submit(producer, pipeline, event)
        excuter.submit(consumer, pipeline, event)

        time.sleep(0.1)
        
        logging.info('Main : ì´ë²¤íŠ¸ë¥¼ Set í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...')

        #í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œì 
        event.set()

```